<!DOCTYPE html><html lang="en-US"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><meta property="og:site_name" content="Mee42.dev"><meta property="og:title" content="Some thoughts on optimization"><meta property="og:type" content="website"><meta property="og:url" content="https://mee42.dev/blog/4#optimization-thoughts"><meta property="og:description" content="A short introduction to basic optimization"></head><body><title>carson.sh | Some thoughts on optimization</title><meta name="next-head-count" content="9"><style>body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}code{font-family:source-code-pro,Menlo,Monaco,Consolas,Courier New,monospace}body{text-align:center;background-color:#fff;min-height:100vh;align-items:center;justify-content:center;color:#000}span.token{background:inherit!important}a{text-decoration:none;color:#417ca3;transition:color .25s}a:hover{color:#002b3e}.header_header__FfSP_{background-color:#fff;z-index:1;color:#000;font-size:1rem;line-height:1.5;position:-webkit-sticky;position:sticky;left:0;top:0;display:flex;flex-direction:row}.header_header__FfSP_ *{margin-left:3em}.header_header__FfSP_ * *{margin-left:0}.header_header__FfSP_ div{display:flex;flex-direction:column}.header_header__FfSP_ div a{color:#000;padding-bottom:0;padding-top:0}.header_header__FfSP_ div .header_withGrow__v2i8T{flex-grow:1}.header_header__FfSP_ div .header_bottomBorder___i6c3{height:1px;background-color:#fff;transition:background-color .5s}.header_header__FfSP_ div:hover .header_bottomBorder___i6c3{background-color:#000}.header_header__FfSP_ a{text-decoration:none}.header_mainButton__no_Oz{color:#fff;background-color:#000;margin:10px;padding:5px 10px;border:1px solid #fff;transition:.5s}.header_mainButton__no_Oz:hover{color:#000;background-color:#fff;border:1px solid #000}.header_header__FfSP_:hover{border-bottom:1px solid hsla(0,0%,50%,.412)}.header_header__FfSP_{border-bottom:1px solid #fff;transition:border-bottom-color .2s}.blogPost_titleBar__IDB6E{display:flex;flex-direction:column;max-width:950px;text-align:left;margin-left:auto;margin-right:auto;margin-top:50px}.blogPost_titleBar__IDB6E .blogPost_title__c_DDP{font-size:40px}.blogPost_titleBar__IDB6E .blogPost_desc__zbW9g{margin-top:10px;font-size:15px}.blogPost_content__11Fk6{max-width:750px;margin-left:auto;margin-right:auto;text-align:left;padding-bottom:250px}.blogPost_post__CGKU6 ul{padding-left:20px}.blogPost_post__CGKU6 pre *{line-height:0;margin:0;padding:0}.blogPost_post__CGKU6 code{background-color:#fbedd4;border:3px #fbedd4;border-radius:3px}</style><link rel="stylesheet" href="/_next/static/css/04dd4dff49ffcaac.css" data-n-g="" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="/_next/static/css/04dd4dff49ffcaac.css"></noscript><link rel="stylesheet" href="/_next/static/css/e29ef9c2db40262f.css" data-n-p="" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="/_next/static/css/e29ef9c2db40262f.css"></noscript><noscript data-n-css=""></noscript><div id="__next"><div><header class="header_header__FfSP_"><a href="/" class="header_mainButton__no_Oz"><code>carson.sh</code></a><div><div class="header_withGrow__v2i8T"></div><a href="/">Home</a><div class="header_withGrow__v2i8T"></div><div class="header_bottomBorder___i6c3"></div></div><div><div class="header_withGrow__v2i8T"></div><a href="/projects">Projects</a><div class="header_withGrow__v2i8T"></div><div class="header_bottomBorder___i6c3"></div></div><div><div class="header_withGrow__v2i8T"></div><a href="/blog">Blog</a><div class="header_withGrow__v2i8T"></div><div class="header_bottomBorder___i6c3"></div></div><div><div class="header_withGrow__v2i8T"></div><a href="https://github.com/mee42/">Github</a><div class="header_withGrow__v2i8T"></div><div class="header_bottomBorder___i6c3"></div></div></header><div class="blogPost_titleBar__IDB6E"><div class="blogPost_title__c_DDP">Some thoughts on optimization</div><div class="blogPost_desc__zbW9g">A short introduction to basic optimization</div></div><div class="blogPost_content__11Fk6 blogPost_post__CGKU6"><h1>Optimization Thoughts</h1>
<p>Optimization is a large topic, and only some basics are going to be covered here.
We'll be talking about <em>AST optimizations</em> today, as it's the most universal form of optimization, independent of backend.</p>
<p>An AST is an <em>Abstract Syntax Tree</em>. This is just how a compiler represents the source code in memory. While we'll being doing a lot of Source Code to Source Code changes for each optimization step, keep in mind that there are not stringy values being manipulated, but a more efficient tree data structure. For the sake of this page, we'll just be working with readable source code.</p>
<p>Let's take a very simple program</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>     </span><span class="token" style="color:#07a">val</span><span> a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span>     </span><span class="token" style="color:#07a">var</span><span> c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> a
</span><span>     c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> </span><span class="token" style="color:#905">1</span><span>
</span><span>     </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> a</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span class="token" style="color:#905">2</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#DD4A68">foo</span><span class="token" style="color:#999">(</span><span>a</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c
</span><span>     </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> a</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#DD4A68">error</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"reached illegal state"</span><span class="token" style="color:#999">)</span><span>
</span><span>     </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c</span><span class="token" style="color:#999">)</span><span> c</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// do some fun doubling</span><span>
</span><span>     </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span>a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span>
</span>
<span></span><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">foo</span><span class="token" style="color:#999">(</span><span>i</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> Int</span><span class="token" style="color:#999">)</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> Int </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">return</span><span> </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">2</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#905">19</span><span> </span><span class="token" style="color:#07a">else</span><span> </span><span class="token" style="color:#905">18</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>Now, let's optimize this down:</p>
<h3>Constant Value Propagation</h3>
<p>Constant Value Propagation, or CVP for short on this page, is taking values that are constant (or static) and propagating them across the program. It's effectively inlining variables that have constant, known values. For example,</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">val</span><span> a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span></span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> a
</span><span></span><span class="token" style="color:#07a">val</span><span> c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> a</span></code></div></pre>
<p>can just be</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">val</span><span> a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span></span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span></span><span class="token" style="color:#07a">val</span><span> c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#905">7</span></code></div></pre>
<p>This is powerful because it eliminates the overhead of fetching variables like constants. This doesn't seem <em>that</em> helpful at first, but it becomes much more useful when combined with other optimizations.</p>
<p>One shortcoming of CVP is that it requires all values to be known at compile time, and for all values to be stored in <strong>final</strong>, or constant variables, so they do not change.</p>
<p>Let's put our example program through some constant value propagation.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>     </span><span class="token" style="color:#07a">val</span><span> a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:slategray">// this is able to be propagated easily</span><span>
</span><span>     </span><span class="token" style="color:#07a">var</span><span> c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:slategray">// this is not, as it is mutable (it might change). However, we still inline the 7 from 'a'</span><span>
</span><span>     c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> </span><span class="token" style="color:#905">1</span><span>
</span><span>     </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span class="token" style="color:#905">2</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#DD4A68">foo</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c </span><span class="token" style="color:slategray">// here we inline the value for 'a'</span><span>
</span><span>     </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">7</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#DD4A68">error</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"reached illegal state"</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:slategray">// everywhere we use 'a' we can replace it with 7</span><span>
</span><span>     </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c</span><span class="token" style="color:#999">)</span><span> c</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c</span><span class="token" style="color:#999">;</span><span> 
</span><span>     </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<h3>Expression Folding</h3>
<p>Expression Folding is pretty simple: pure operations, like arithmetics on pure expressions, can be done at compile time.
Purity in this context means it doesn't matter if it's actually evaluated at runtime;
<code>print(4)</code> is <em>impure</em>, because if you removed it, the program would work differently.
A <em>pure</em> expression can be removed without affecting the program,
<code>7 + 8</code> does not need to be computed at runtime if the program does not use the resulting sum.
There's also no need to do <code>2+2</code> at runtime when the compiler can just insert <code>4</code>, because addition is pure.
Given this, we can somewhat reduce the amount of computation we'll do at compile time. In each of theses steps, we'll be continuing on from the function before it, so the input to this optimization step is the outputted function above from Constant Value Propagation.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>     </span><span class="token" style="color:#07a">val</span><span> a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> 
</span><span>     </span><span class="token" style="color:#07a">var</span><span> c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> 
</span><span>     c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> </span><span class="token" style="color:#905">1</span><span>
</span><span>     </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">14</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#DD4A68">foo</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c  </span><span class="token" style="color:slategray">// '7*2' can be changed to '14'</span><span>
</span><span>     </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">7</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#DD4A68">error</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"reached illegal state"</span><span class="token" style="color:#999">)</span><span>
</span><span>     </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c</span><span class="token" style="color:#999">)</span><span> c</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c</span><span class="token" style="color:#999">;</span><span> 
</span><span>     </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>This is again, something that isn't very helpful without some other optimizations, which we'll get to below.</p>
<h3>Inlining of functions</h3>
<p>We can inline short functions into the original source code. This can sometimes increase execution speed for a couple reasons: The basic improvement is that we don't need to store the arguments, call, return, and get back the result. This is generally a smaller increase in speed, and is pretty much only important on short functions like <code>abs</code> or <code>max</code>, where the call overhead is comparable to the actual functionality.</p>
<p>The more important thing is that it brings more context into the caller function for the compiler to work with. Inlining lets the compiler optimize the callee in the context of the caller, instead of optimizing them separately.</p>
<p>Lets inline <code>foo</code> into our original function.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>     </span><span class="token" style="color:#07a">val</span><span> a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> 
</span><span>     </span><span class="token" style="color:#07a">var</span><span> c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> 
</span><span>     c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> </span><span class="token" style="color:#905">1</span><span>
</span><span>     </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">14</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token label" style="color:#905">block@</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>         </span><span class="token" style="color:#07a">val</span><span> i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span>         </span><span class="token" style="color:#07a">return</span><span class="token label" style="color:#905">@block</span><span> </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">2</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#905">19</span><span> </span><span class="token" style="color:#07a">else</span><span> </span><span class="token" style="color:#905">18</span><span>
</span><span>     </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c
</span><span>     </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">7</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#DD4A68">error</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"reached illegal state"</span><span class="token" style="color:#999">)</span><span>
</span><span>     </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c</span><span class="token" style="color:#999">)</span><span> c</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c</span><span class="token" style="color:#999">;</span><span> 
</span><span>     </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>This is getting into some more complex Kotlin syntax, but you can think of it like a block (several statements) being used as an expression. The <code>block@</code> allows it to return the value locally. As an example,</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token label" style="color:#905">block@</span><span> </span><span class="token" style="color:#999">{</span><span> </span><span class="token" style="color:#07a">return</span><span class="token label" style="color:#905">@block</span><span> </span><span class="token" style="color:#905">1</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#905">20</span><span> </span><span class="token" style="color:#999">}</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#905">300</span></code></div></pre>
<p>would evaluate to <code>321</code></p>
<p>You can see how we set <code>i</code> to the value we passed in for <code>i</code> in the original function, <code>7</code>.</p>
<p>Now, we can optimize this further with expression folding and constant value propagation. We'll look at just the block for a second.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token label" style="color:#905">block@</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span>    </span><span class="token" style="color:#07a">return</span><span class="token label" style="color:#905">@block</span><span> </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">2</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#905">19</span><span> </span><span class="token" style="color:#07a">else</span><span> </span><span class="token" style="color:#905">18</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span></code></div></pre>
<p><code>if(7 &lt; 2)</code> will clearly fold down to <code>true</code>, so we can simplify just down to <code>19</code>.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token label" style="color:#905">block@</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span>    </span><span class="token" style="color:#07a">return</span><span class="token label" style="color:#905">@block</span><span> </span><span class="token" style="color:#905">19</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span></code></div></pre>
<p>Because this is kotlin, we can optimize <code>block@ { return@block 19 }</code> down to <code>19</code>. This gives us, back to our original function.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> 
</span><span>    </span><span class="token" style="color:#07a">var</span><span> c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> 
</span><span>    c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> </span><span class="token" style="color:#905">1</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">14</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#905">19</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c </span><span class="token" style="color:slategray">// note the 19 here</span><span>
</span><span>    </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">7</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#DD4A68">error</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"reached illegal state"</span><span class="token" style="color:#999">)</span><span>
</span><span>    </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c</span><span class="token" style="color:#999">)</span><span> c</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c</span><span class="token" style="color:#999">;</span><span> 
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>And we can fold some more!</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> 
</span><span>    </span><span class="token" style="color:#07a">var</span><span> c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span>    c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> </span><span class="token" style="color:#905">1</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">23</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c </span><span class="token" style="color:slategray">// added 14 and 19 together</span><span>
</span><span>    </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">7</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#DD4A68">error</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"reached illegal state"</span><span class="token" style="color:#999">)</span><span>
</span><span>    </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c</span><span class="token" style="color:#999">)</span><span> c</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c</span><span class="token" style="color:#999">;</span><span> 
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>Now, this is great and all, but it isn't perfect. You or me could optimize this better, so we're going to need a couple more tools.</p>
<h3>Dead Code Elimination</h3>
<p>Dead Code Elimination, or DCE, is removing code that does nothing. This is a pretty simple reducement of the code</p>
<ul>
<li>If a variable is not used, it can be reduced to the expression it's set to</li>
</ul>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">val</span><span> a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b</span><span class="token" style="color:slategray">// can turn to</span><span>
</span><span></span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b </span><span class="token" style="color:slategray">// just sitting there</span></code></div></pre>
<ul>
<li>If an expression is not used, and it is pure, it can be deleted</li>
</ul>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:slategray">// would be allowed to deleted</span></code></div></pre>
<ul>
<li>If an expression is not used, and the outer layer is pure, the outer layer can be deleted</li>
</ul>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#DD4A68">foo</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#DD4A68">bar</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:slategray">// if this exists, and is not used, it can be optimized to</span><span>
</span><span></span><span class="token" style="color:#DD4A68">foo</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:#DD4A68">bar</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:slategray">// with no add</span></code></div></pre>
<ul>
<li>If some code is unreachable, it can be deleted. This one we won't touch on today as it's more language-specific</li>
</ul>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">return</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span></span><span class="token" style="color:#DD4A68">print</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"hi!"</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:slategray">// this line can be deleted as it will never be reached</span></code></div></pre>
<p>With these rules, we can delete the <code>a</code> variable from our program, and it's value <code>7</code> as it's pure.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:slategray">// no more a lol</span><span>
</span><span>    </span><span class="token" style="color:#07a">var</span><span> c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> 
</span><span>    c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> </span><span class="token" style="color:#905">1</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">23</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c
</span><span>    </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">7</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#DD4A68">error</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"reached illegal state"</span><span class="token" style="color:#999">)</span><span>
</span><span>    </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c</span><span class="token" style="color:#999">)</span><span> c</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c</span><span class="token" style="color:#999">;</span><span> 
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>Now, this is pretty nice. However, it's not <em>that</em> good. It could be much better. And to do that, we're going to need some better tools</p>
<h3>Static Single Assignment Form</h3>
<p>Also known as SSA, this one is rather hard to implement in compilers. However, we'll give it a go.</p>
<p>SSA is the idea "what if, every variable was final, and we just made a new variable every single time we assigned it?"</p>
<p>For example, a trivial program like</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">var</span><span> foo </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span>foo </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> foo</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span>foo</span></code></div></pre>
<p>might look hard to optimize logically. If we use SSA, though, we get</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">val</span><span> foo_0 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span></span><span class="token" style="color:#07a">val</span><span> foo_1 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> foo_0 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> foo_0 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span> foo_0</span></code></div></pre>
<p>which can be optimized down to a perfect constant, <code>val foo_1 = 56</code>, trivially with the above methods.</p>
<p>Let's run our program through SSA.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_0 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span>    c_1 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> c_0 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#905">1</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">23</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_1
</span><span>    </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">7</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#DD4A68">error</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"reached illegal state"</span><span class="token" style="color:#999">)</span><span>
</span><span>    </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c</span><span class="token" style="color:#999">)</span><span> c</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// wait a minute, what do we do here?</span><span>
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>The answer is that we make a very fancy control flow graph, which recurs on itself, and has a finite amount of c_n variables.</p>
<p>However, that is hard! We're going to skip that for now, and introduce a <code>c_mut</code> variable for when we need to do that</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_0 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_1 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> c_0 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#905">1</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">23</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_1
</span><span>    </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">7</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#DD4A68">error</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"reached illegal state"</span><span class="token" style="color:#999">)</span><span>
</span><span>    </span><span class="token" style="color:#07a">var</span><span> c_mut </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> c_1
</span><span>    </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c_mut</span><span class="token" style="color:#999">)</span><span> c_mut</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c_mut
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_mut</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>Now, you can see here it's trivial to evaluate large amounts of this code</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_0 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_1 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#905">1</span><span> </span><span class="token" style="color:slategray">// c_0 can be rolled into here, so we should really do</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_1 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">8</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">23</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_1 </span><span class="token" style="color:slategray">// we can also evaluate this simply, and we should actually just do</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">31</span><span> </span><span class="token" style="color:slategray">// 2^5-1, nice</span><span>
</span><span>    </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">31</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">7</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#DD4A68">error</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"reached illegal state"</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:slategray">// DCE can delete this statement as it'll never run, as well as the 'if' statement</span><span>
</span><span>    </span><span class="token" style="color:#07a">var</span><span> c_mut </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> c_1</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// we'll wait on optimizing this for a bit</span><span>
</span><span>    </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">31</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c_mut</span><span class="token" style="color:#999">)</span><span> c_mut</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c_mut
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">7</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#905">31</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_mut</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// inlining of b, should really be</span><span>
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">38</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_mut</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:slategray">// evaluating the addition</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>That was a big mess of duplicate lines, so let's rewrite that</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_0 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_1 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">8</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">31</span><span>
</span><span>    </span><span class="token" style="color:#07a">var</span><span> c_mut </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> c_1</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// we'll wait on optimizing this for a bit</span><span>
</span><span>    </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">31</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c_mut</span><span class="token" style="color:#999">)</span><span> c_mut</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c_mut
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">38</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_mut</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:slategray">// evaluating the addition</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>Let's run DCE real quick, as we can delete <code>c_0</code>, <code>c_1</code>, and <code>b</code>.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">var</span><span> c_mut </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">8</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// we'll wait on optimizing this for a bit</span><span>
</span><span>    </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">31</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c_mut</span><span class="token" style="color:#999">)</span><span> c_mut</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c_mut
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">38</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_mut</span><span class="token" style="color:#999">)</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>Now, this is pretty damn good, what we've done already.
However, because I added this at the beginning, I feel obligated to finish it off :p</p>
<h3>How (not really) to do loops in SSA</h3>
<p>Let's make an assumption that normal compilers are unable to make: that the loop will terminate within 5 iterations.
This is the only way to solve this without a nice, recursive graph, which is hard to represent in a textual format.
This is <em>not</em> how this is done in actual compilers.</p>
<p>So, let's think about how we can remove this loop. We need to remember how while loops actually flow.</p>
<pre><code>               /----------false-------\       
start -&gt; conditional ---true--&gt; body-&gt; \---&gt; rest of the program
            /\                  /
             \-----------------/
</code></pre>
<p>If we want to remove the recursive structure here, we could do it manually just by repeating the conditional. Here's a loop that runs max 2 iterations</p>
<pre><code>               /-------false------------------------------------------------\/
start -&gt; conditional --true--&gt; body -&gt; conditional --true--&gt; body -------&gt; rest of the program
                                            \--------false------------------/\
</code></pre>
<p>We could model this with an <code>if</code> statement,</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>cond</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span>    body
<span>    </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>cond</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span>        body
<span>    </span><span class="token" style="color:#999">}</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>Knowing this, we can change our original program (<em>again, you need to remember that this only works when we have a small upper iteration limit</em>)</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_10 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">8</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>c_10 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">31</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>        </span><span class="token" style="color:#07a">val</span><span> c_11 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> c_10 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_10
</span><span>        </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>c_11 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">31</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>            </span><span class="token" style="color:#07a">val</span><span> c_12 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> c_11 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_12
</span><span>            </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>c_12 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">31</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>                </span><span class="token" style="color:#07a">val</span><span> c_13 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> c_12 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_12
</span><span>                </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>c_13 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">31</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>                    </span><span class="token" style="color:#07a">val</span><span> c_14 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> c_13 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_13
</span><span>                    </span><span class="token" style="color:slategray">// at this point, c_14 is &lt;31 (as per our assumption)</span><span>
</span><span>                </span><span class="token" style="color:#999">}</span><span>
</span><span>            </span><span class="token" style="color:#999">}</span><span>
</span><span>        </span><span class="token" style="color:#999">}</span><span>
</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span>    </span><span class="token" style="color:slategray">// we still have an issue here, what variable do we print here?</span><span>
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">38</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#999">)</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>The answer to the <code>c_???</code> question is: there's not a great way to figure this out. Again, normal ~~people~~ compilers would use proper SSA and not have this problem. We'll just.. ignore it for now. The answer will be obvious after some - you guessed it! - expression folding and variable inlining.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_10 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">8</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span class="token" style="color:slategray">/*c_10 &lt; 31*/</span><span> </span><span class="token" style="color:#905">true</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>        </span><span class="token" style="color:slategray">//val c_11 = 8 + 8</span><span>
</span><span>        </span><span class="token" style="color:#07a">val</span><span> c_11 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">16</span><span>
</span><span>        </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span class="token" style="color:slategray">/*c_11 &lt; 31*/</span><span> </span><span class="token" style="color:#905">true</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>            </span><span class="token" style="color:slategray">// val c_12 = 16 + 16</span><span>
</span><span>            </span><span class="token" style="color:#07a">val</span><span> c_12 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">32</span><span>
</span><span>            </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span class="token" style="color:slategray">/*c_12 &lt; 31*/</span><span> </span><span class="token" style="color:#905">false</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>                </span><span class="token" style="color:slategray">/*val c_13 = c_12 + c_12 
</span><span class="token" style="color:slategray">                if(c_13 &lt; 31) {          // all of this can be deleted as the 'if' statement will evaluate to false, via DCE
</span><span class="token" style="color:slategray">                    val c_14 = c_13 + c_13
</span><span class="token" style="color:slategray">                }*/</span><span>
</span><span>            </span><span class="token" style="color:#999">}</span><span>
</span><span>        </span><span class="token" style="color:#999">}</span><span>
</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">38</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#999">)</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>With SSA, the lines between scopes are blurred</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_10 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">8</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_11 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">16</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_12 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">32</span><span>
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">38</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c_</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#999">)</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>I guess we can assume our <code>c_???</code> to be <code>c_12</code>, as it's the last version of <code>c</code> ever set (remember that these are still just <code>c</code> in the original function), which gives us</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_10 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">8</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_11 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">16</span><span>
</span><span>    </span><span class="token" style="color:#07a">val</span><span> c_12 </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">32</span><span>
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">38</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#905">32</span><span class="token" style="color:#999">)</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>...DCE</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">38</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#905">32</span><span class="token" style="color:#999">)</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>...folding</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span class="token" style="color:#905">70</span><span class="token" style="color:#999">)</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>Woo! We've perfectly optimized this program, in a logical process. For reference, here's the original function.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-kt" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>     </span><span class="token" style="color:#07a">val</span><span> a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#905">7</span><span>
</span><span>     </span><span class="token" style="color:#07a">var</span><span> c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> a
</span><span>     c </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span> </span><span class="token" style="color:#905">1</span><span>
</span><span>     </span><span class="token" style="color:#07a">val</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> a</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">*</span><span class="token" style="color:#905">2</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> </span><span class="token" style="color:#DD4A68">foo</span><span class="token" style="color:#999">(</span><span>a</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c
</span><span>     </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> a</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#DD4A68">error</span><span class="token" style="color:#999">(</span><span class="token string-literal singleline" style="color:#690">"reached illegal state"</span><span class="token" style="color:#999">)</span><span>
</span><span>     </span><span class="token" style="color:#07a">while</span><span class="token" style="color:#999">(</span><span>b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> c</span><span class="token" style="color:#999">)</span><span> c</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+=</span><span>c</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// do some fun doubling</span><span>
</span><span>     </span><span class="token" style="color:#DD4A68">println</span><span class="token" style="color:#999">(</span><span>a </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> b </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> c</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span>
</span>
<span></span><span class="token" style="color:#07a">fun</span><span> </span><span class="token" style="color:#DD4A68">foo</span><span class="token" style="color:#999">(</span><span>i</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> Int</span><span class="token" style="color:#999">)</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> Int </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">return</span><span> </span><span class="token" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span>i </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span> </span><span class="token" style="color:#905">2</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#905">19</span><span> </span><span class="token" style="color:#07a">else</span><span> </span><span class="token" style="color:#905">18</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre></div></div></div></body></html>